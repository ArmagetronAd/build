#!/bin/bash
# updates 0install stream xml for new release 

# expected variables:
# SERIES
# VERSION
# FILE
# PACKAGE
# OSTAG_GENERIC

set -x

# transform version for 0install
ZEROVERSION=$(echo ${VERSION} | sed -e "s,_,-,g" -e "s,-alpha,-pre0.," -e "s,-beta,-pre1.," -e "s,\.-z,.," )
# and launchpad
LPVERSION=$(echo ${VERSION} | sed -e "s,_,-,g" )

# library and data files
LIBFILE=$(echo ${FILE} | sed -e "s,${PACKAGE},${PACKAGE}-libs,")
DATAFILE=$(echo ${FILE} | sed -e "s,${PACKAGE},${PACKAGE}-data," -e "s,${OSTAG_GENERIC}.,,")

# construct uri
URI=http://launchpad.net/armagetronad/${SERIES}/${LPVERSION}/+download/$(basename ${FILE})
LIBURI=http://launchpad.net/armagetronad/${SERIES}/${LPVERSION}/+download/$(basename ${LIBFILE})
DATAURI=http://launchpad.net/armagetronad/${SERIES}/${LPVERSION}/+download/$(basename ${DATAFILE})

# determine xml to modify
XML=
test "${SERIES}" == "0.2.8" && XML=0install/armagetronad-beta
test "${SERIES}" == "0.2.8-snapshots" && XML=0install/armagetronad-alpha
test "${SERIES}" == "trunk-snapshots" && XML=0install/armagetronad-experimental
test -z ${XML} && { echo "Unknown series: ${SERIES}"; exit 1; }

OS=Linux
CPU=$(echo ${OSTAG_GENERIC} | sed -e "s,-.*,,")
ARCH=${OS}-${CPU}

# add the release
if test -r ${FILE} && ! grep -q version=\"${ZEROVERSION}\" ${XML}-${ARCH}.xml; then
 0launch -c 'http://0install.net/2006/interfaces/0publish' \
  ${XML}-${ARCH}.xml \
 --add-version ${ZEROVERSION} \
 --archive-url=${URI} \
 --archive-file=${FILE} \
 --set-main=usr/local/bin/${PACKAGE}\
 --set-released=today
fi

if test -r ${LIBFILE} && ! grep -q version=\"${ZEROVERSION}\" 0install/armagetronad-libs-${ARCH}.xml; then
  0launch -c 'http://0install.net/2006/interfaces/0publish' \
  0install/armagetronad-libs-${ARCH}.xml \
 --add-version ${ZEROVERSION} \
 --archive-url=${LIBURI} \
 --archive-file=${LIBFILE} \
 --set-released=today
fi

if test -r ${DATAFILE} && ! grep -q version=\"${ZEROVERSION}\" 0install/armagetronad-data.xml; then
  0launch -c 'http://0install.net/2006/interfaces/0publish' \
  0install/armagetronad-data.xml \
 --add-version ${ZEROVERSION} \
 --archive-url=${DATAURI} \
 --archive-file=${DATAFILE} \
 --set-released=today
fi
